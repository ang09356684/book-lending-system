# 館藏管理與借閱系統設計文檔

## 目錄
1. [系統概述](#系統概述)
2. [資料庫設計](#資料庫設計)
3. [館藏管理功能](#館藏管理功能)
4. [借閱系統設計](#借閱系統設計)
5. [API設計](#api設計)
6. [權限控制](#權限控制)
7. [實作建議](#實作建議)

---

## 系統概述

### 核心需求
- 館員可新增書籍至系統(支援多館館藏與同館多副本)
- 搜尋結果需顯示書籍基本資訊及各館館藏數量(可用數量)
- 精確追蹤用戶借閱的具體副本

### 設計原則
- **副本平等性**：所有副本都是平等的，不區分正本副本
- **精確追蹤**：每個借閱記錄都關聯到具體的副本
- **多館支援**：支援跨圖書館的館藏管理
- **狀態管理**：每個副本都有獨立的狀態管理

---

## 資料庫設計

### 核心表格關係

```
books (書籍基本資訊)
├── book_copies (館藏副本)
│   ├── libraries (圖書館)
│   └── borrow_records (借閱記錄)
│       └── users (用戶)
```

### 詳細表格結構

#### 1. books (書籍基本資訊)
```sql
CREATE TABLE books (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,           -- 書名
    author VARCHAR(200) NOT NULL,          -- 作者
    published_year INT,                    -- 出版年份
    category VARCHAR(50) NOT NULL,         -- 分類
    book_type VARCHAR(20) NOT NULL,        -- 書籍類型
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. book_copies (館藏副本)
```sql
CREATE TABLE book_copies (
    id BIGSERIAL PRIMARY KEY,
    book_id BIGINT NOT NULL,               -- 關聯書籍
    library_id BIGINT NOT NULL,            -- 關聯圖書館
    copy_number INT NOT NULL,              -- 副本編號
    status VARCHAR(20) NOT NULL DEFAULT 'AVAILABLE',
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(book_id, library_id, copy_number)  -- 確保副本編號唯一
);
```

#### 3. borrow_records (借閱記錄)
```sql
CREATE TABLE borrow_records (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,               -- 借閱用戶
    book_copy_id BIGINT NOT NULL,          -- 具體副本
    borrowed_at TIMESTAMP DEFAULT NOW(),   -- 借閱時間
    due_at TIMESTAMP NOT NULL,             -- 應還時間
    returned_at TIMESTAMP,                 -- 實際歸還時間
    status VARCHAR(20) NOT NULL DEFAULT 'BORROWED'
);
```

### 副本識別機制

#### 副本編號規則
- **格式**：`(book_id, library_id, copy_number)`
- **唯一性**：同一本書在同一圖書館的副本編號不能重複
- **範圍**：copy_number 從 1 開始遞增

#### 範例
```
書籍 "Java程式設計" (id=1)
├── 總館副本1: (book_id=1, library_id=1, copy_number=1)
├── 總館副本2: (book_id=1, library_id=1, copy_number=2)
└── 分館副本1: (book_id=1, library_id=2, copy_number=1)
```

---

## 館藏管理功能

### 1. 新增書籍流程

#### 步驟1：新增書籍基本資訊
```java
POST /api/books
{
    "title": "Java程式設計",
    "author": "張三",
    "publishedYear": 2024,
    "category": "電腦科學",
    "bookType": "圖書"
}
```

#### 步驟2：新增館藏副本
```java
POST /api/books/{bookId}/copies
{
    "libraryId": 1,
    "copyNumber": 1,
    "quantity": 3  // 一次新增多個副本
}
```

### 2. 館藏狀態管理

#### 副本狀態
- **AVAILABLE**：可借閱
- **BORROWED**：已借出
- **LOST**：遺失
- **DAMAGED**：損壞

#### 狀態變更規則
- 借閱時：AVAILABLE → BORROWED
- 歸還時：BORROWED → AVAILABLE
- 遺失時：任意狀態 → LOST
- 損壞時：任意狀態 → DAMAGED

---

## 借閱系統設計

### 1. 借閱流程

#### 借閱步驟
1. **搜尋書籍**：用戶搜尋想要的書籍
2. **選擇副本**：系統顯示可用的副本
3. **執行借閱**：選擇具體副本進行借閱
4. **更新狀態**：副本狀態變更為 BORROWED
5. **建立記錄**：在 borrow_records 中建立借閱記錄

#### 借閱記錄範例
```sql
-- 用戶借閱記錄
INSERT INTO borrow_records (user_id, book_copy_id, due_at) 
VALUES (1, 2, NOW() + INTERVAL '1 month');

-- 更新副本狀態
UPDATE book_copies SET status = 'BORROWED' WHERE id = 2;
```

### 2. 歸還流程

#### 歸還步驟
1. **掃描副本**：館員掃描歸還的副本
2. **驗證記錄**：確認借閱記錄存在
3. **更新狀態**：副本狀態變更為 AVAILABLE
4. **完成歸還**：更新 borrow_records 的歸還時間

### 3. 精確追蹤機制

#### 追蹤優勢
- **具體副本**：知道借的是哪個具體副本
- **跨館追蹤**：可以追蹤跨圖書館的借閱
- **狀態同步**：副本狀態與借閱記錄同步
- **歷史記錄**：保留完整的借閱歷史

#### 查詢範例
```sql
-- 查詢用戶借閱的具體副本
SELECT 
    b.title,
    l.name as library_name,
    bc.copy_number,
    br.borrowed_at,
    br.due_at
FROM borrow_records br
JOIN book_copies bc ON br.book_copy_id = bc.id
JOIN books b ON bc.book_id = b.id
JOIN libraries l ON bc.library_id = l.id
WHERE br.user_id = 1;
```

---

## API設計

### 1. 書籍管理API

#### 新增書籍
```http
POST /api/books
Authorization: Bearer {token}
Content-Type: application/json

{
    "title": "書名",
    "author": "作者",
    "publishedYear": 2024,
    "category": "分類",
    "bookType": "圖書"
}
```

#### 搜尋書籍（含館藏資訊）
```http
GET /api/books/search?keyword=Java
Authorization: Bearer {token}
```

**回應格式**
```json
{
    "success": true,
    "data": [
        {
            "id": 1,
            "title": "Java程式設計",
            "author": "張三",
            "publishedYear": 2024,
            "category": "電腦科學",
            "bookType": "圖書",
            "libraryAvailability": [
                {
                    "libraryId": 1,
                    "libraryName": "總館",
                    "totalCopies": 3,
                    "availableCopies": 2
                },
                {
                    "libraryId": 2,
                    "libraryName": "分館",
                    "totalCopies": 1,
                    "availableCopies": 1
                }
            ]
        }
    ]
}
```

### 2. 館藏管理API

#### 新增館藏副本
```http
POST /api/books/{bookId}/copies
Authorization: Bearer {token}
Content-Type: application/json

{
    "libraryId": 1,
    "copyNumber": 1,
    "quantity": 3
}
```

#### 查詢館藏狀態
```http
GET /api/books/{bookId}/copies
Authorization: Bearer {token}
```

### 3. 借閱管理API

#### 借閱書籍
```http
POST /api/borrows
Authorization: Bearer {token}
Content-Type: application/json

{
    "bookCopyId": 2
}
```

#### 歸還書籍
```http
PUT /api/borrows/{borrowId}/return
Authorization: Bearer {token}
```

---

## 權限控制

### 角色權限矩陣

| 功能 | 一般用戶 | 館員 |
|------|----------|------|
| 搜尋書籍 | ✅ | ✅ |
| 查看館藏資訊 | ✅ | ✅ |
| 借閱書籍 | ✅ | ✅ |
| 歸還書籍 | ✅ | ✅ |
| 新增書籍 | ❌ | ✅ |
| 新增館藏 | ❌ | ✅ |
| 管理館藏狀態 | ❌ | ✅ |

### 權限配置
```java
// SecurityConfig.java
.requestMatchers("/books").hasRole("LIBRARIAN")           // 新增書籍
.requestMatchers("/books/*/copies").hasRole("LIBRARIAN")  // 管理館藏
.requestMatchers("/borrows").authenticated()              // 借閱功能
```

---

## 實作建議

### 階段1：完善搜尋功能
1. 建立 `BookSearchResponse` DTO
2. 建立 `LibraryAvailability` DTO
3. 修改 `BookService.searchBooks()` 方法
4. 新增 Repository 查詢方法

### 階段2：館藏管理功能
1. 建立 `BookCopyService`
2. 新增館藏管理 Controller
3. 實作副本編號驗證邏輯

### 階段3：借閱功能優化
1. 優化借閱流程
2. 實作副本狀態同步
3. 新增借閱記錄查詢功能

### 階段4：測試與優化
1. 單元測試
2. 整合測試
3. 效能優化

---

## 技術要點

### 1. 資料一致性
- 使用資料庫約束確保副本編號唯一性
- 使用事務確保借閱操作的原子性
- 定期同步副本狀態與借閱記錄

### 2. 效能考量
- 建立適當的索引
- 使用分頁查詢
- 快取熱門書籍資訊

### 3. 擴展性
- 支援多圖書館架構
- 支援不同類型的館藏
- 支援複雜的搜尋條件

---

*最後更新：2025年1月*
