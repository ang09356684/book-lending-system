# éšæ®µ6: å¤–éƒ¨APIæ•´åˆ

## ğŸ“‹ **å­¸ç¿’ç›®æ¨™**

æœ¬æ–‡ä»¶å°‡è©³ç´°èªªæ˜å¦‚ä½•æ•´åˆå¤–éƒ¨APIä¾†é©—è­‰é¤¨å“¡èº«ä»½ï¼Œå¯¦ç¾èˆ‡å…¶ä»–ç³»çµ±çš„æ•´åˆã€‚

### **å­¸ç¿’é‡é»**
- äº†è§£å¤–éƒ¨APIæ•´åˆçš„ç›®çš„å’Œé‡è¦æ€§
- å­¸ç¿’å¦‚ä½•ä½¿ç”¨RestTemplateé€²è¡ŒHTTPè«‹æ±‚
- æŒæ¡å¤–éƒ¨APIçš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- ç†è§£é…ç½®ç®¡ç†çš„æœ€ä½³å¯¦è¸

---

## ğŸ¯ **å¤–éƒ¨APIæ•´åˆæ¦‚è¿°**

### **ç‚ºä»€éº¼éœ€è¦å¤–éƒ¨APIæ•´åˆï¼Ÿ**

åœ¨å¯¦éš›çš„åœ–æ›¸é¤¨ç³»çµ±ä¸­ï¼Œé¤¨å“¡èº«ä»½é©—è­‰é€šå¸¸éœ€è¦èˆ‡ç¾æœ‰çš„äººäº‹ç³»çµ±æˆ–é¤¨å“¡ç®¡ç†ç³»çµ±é€²è¡Œæ•´åˆï¼Œç¢ºä¿ï¼š

- âœ… **èº«ä»½é©—è­‰çš„æ¬Šå¨æ€§** - åªæœ‰çœŸæ­£çš„é¤¨å“¡æ‰èƒ½è¨»å†Šé¤¨å“¡å¸³è™Ÿ
- âœ… **è³‡æ–™ä¸€è‡´æ€§** - é¿å…é‡è¤‡å»ºç«‹é¤¨å“¡è³‡æ–™
- âœ… **æ¬Šé™æ§åˆ¶** - é¤¨å“¡æœ‰ç‰¹æ®Šæ¬Šé™ï¼Œéœ€è¦åš´æ ¼é©—è­‰
- âœ… **ç³»çµ±æ•´åˆ** - èˆ‡ç¾æœ‰çš„ç®¡ç†ç³»çµ±ä¿æŒåŒæ­¥

### **æ•´åˆéœ€æ±‚**

æ ¹æ“šPRDæ–‡ä»¶ï¼Œé¤¨å“¡è¨»å†Šæ™‚éœ€è¦ï¼š

```http
Method: GET
URL: https://todo.com.tw
Headers: { "Authorization": "todo" }
```

---

## ğŸ”§ **å¯¦ä½œæ­¥é©Ÿ**

### **æ­¥é©Ÿ1: å»ºç«‹ExternalApiService**

```java
@Service
public class ExternalApiService {
    
    private final RestTemplate restTemplate;
    
    @Value("${external.librarian.verification-url:https://todo.com.tw}")
    private String verificationUrl;
    
    @Value("${external.librarian.authorization-header:todo}")
    private String authorizationHeader;
    
    public ExternalApiService() {
        this.restTemplate = new RestTemplate();
    }
    
    public boolean verifyLibrarian(String librarianId) {
        // å¯¦ä½œå¤–éƒ¨APIå‘¼å«é‚è¼¯
    }
}
```

### **æ­¥é©Ÿ2: é…ç½®ç®¡ç†**

åœ¨ `application.yml` ä¸­é…ç½®å¤–éƒ¨APIåƒæ•¸ï¼š

```yaml
# External API configuration
external:
  librarian:
    verification-url: https://todo.com.tw
    authorization-header: todo
```

### **æ­¥é©Ÿ3: æ•´åˆåˆ°UserService**

```java
@Service
public class UserService {
    
    private final ExternalApiService externalApiService;
    
    public User registerLibrarian(String username, String email, String password, String fullName, String librarianId) {
        // é©—è­‰è¼¸å…¥åƒæ•¸
        
        // å‘¼å«å¤–éƒ¨APIé©—è­‰é¤¨å“¡èº«ä»½
        boolean isVerified = externalApiService.verifyLibrarian(librarianId);
        if (!isVerified) {
            throw new RuntimeException("Librarian verification failed");
        }
        
        // å»ºç«‹é¤¨å“¡å¸³è™Ÿ
        // ...
    }
}
```

---

## ğŸ“š **æ ¸å¿ƒæ¦‚å¿µ**

### **1. RestTemplate**

RestTemplateæ˜¯Springæä¾›çš„HTTPå®¢æˆ¶ç«¯å·¥å…·ï¼Œç”¨æ–¼å‘¼å«å¤–éƒ¨APIï¼š

```java
// å»ºç«‹RestTemplate
RestTemplate restTemplate = new RestTemplate();

// è¨­å®šè«‹æ±‚æ¨™é ­
HttpHeaders headers = new HttpHeaders();
headers.set("Authorization", "todo");

// å»ºç«‹HTTPå¯¦é«”
HttpEntity<String> entity = new HttpEntity<>(headers);

// ç™¼é€GETè«‹æ±‚
ResponseEntity<String> response = restTemplate.exchange(
    "https://todo.com.tw",
    HttpMethod.GET,
    entity,
    String.class
);
```

### **2. é…ç½®æ³¨å…¥**

ä½¿ç”¨ `@Value` è¨»è§£å¾é…ç½®æª”æ¡ˆæ³¨å…¥åƒæ•¸ï¼š

```java
@Value("${external.librarian.verification-url}")
private String verificationUrl;

@Value("${external.librarian.authorization-header}")
private String authorizationHeader;
```

### **3. éŒ¯èª¤è™•ç†**

å¤–éƒ¨APIå‘¼å«å¯èƒ½å¤±æ•—ï¼Œéœ€è¦é©ç•¶çš„éŒ¯èª¤è™•ç†ï¼š

```java
try {
    // å‘¼å«å¤–éƒ¨API
    ResponseEntity<String> response = restTemplate.exchange(...);
    return response.getStatusCode().is2xxSuccessful();
} catch (RestClientException e) {
    // è¨˜éŒ„éŒ¯èª¤ä¸¦è¿”å›false
    System.err.println("External API verification failed: " + e.getMessage());
    return false;
}
```

---

## âš ï¸ **æ³¨æ„äº‹é …**

### **1. ç¶²è·¯å»¶é²**

å¤–éƒ¨APIå‘¼å«æœƒå¢åŠ éŸ¿æ‡‰æ™‚é–“ï¼š

```java
// å»ºè­°è¨­å®šè¶…æ™‚æ™‚é–“
@Bean
public RestTemplate restTemplate() {
    SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory();
    factory.setConnectTimeout(5000);  // 5ç§’é€£æ¥è¶…æ™‚
    factory.setReadTimeout(10000);    // 10ç§’è®€å–è¶…æ™‚
    return new RestTemplate(factory);
}
```

### **2. éŒ¯èª¤è™•ç†**

å¤–éƒ¨APIå¯èƒ½ä¸å¯ç”¨ï¼Œéœ€è¦å„ªé›…çš„éŒ¯èª¤è™•ç†ï¼š

```java
public boolean verifyLibrarian(String librarianId) {
    try {
        // å‘¼å«å¤–éƒ¨API
        return callExternalApi(librarianId);
    } catch (Exception e) {
        // è¨˜éŒ„éŒ¯èª¤
        log.error("External API verification failed for librarian: " + librarianId, e);
        
        // æ ¹æ“šæ¥­å‹™éœ€æ±‚æ±ºå®šæ˜¯å¦å…è¨±è¨»å†Š
        // é¸é …1: æ‹’çµ•è¨»å†Š
        return false;
        
        // é¸é …2: å…è¨±è¨»å†Šï¼ˆéœ€è¦ç®¡ç†å“¡å¯©æ ¸ï¼‰
        // return true;
    }
}
```

### **3. å®‰å…¨æ€§**

å¤–éƒ¨APIå‘¼å«æ¶‰åŠæ•æ„Ÿè³‡è¨Šï¼Œéœ€è¦æ³¨æ„å®‰å…¨ï¼š

```java
// ä¸è¦åœ¨æ—¥èªŒä¸­è¨˜éŒ„æ•æ„Ÿè³‡è¨Š
log.info("Verifying librarian with external system");  // âœ… æ­£ç¢º
log.info("Verifying librarian ID: " + librarianId);    // âŒ é¿å…è¨˜éŒ„æ•æ„Ÿè³‡è¨Š
```

### **4. æ¸¬è©¦**

å¤–éƒ¨APIæ•´åˆéœ€è¦ç‰¹åˆ¥çš„æ¸¬è©¦ç­–ç•¥ï¼š

```java
@Test
void testLibrarianVerification() {
    // ä½¿ç”¨Mockitoæ¨¡æ“¬å¤–éƒ¨API
    when(externalApiService.verifyLibrarian("valid-id")).thenReturn(true);
    when(externalApiService.verifyLibrarian("invalid-id")).thenReturn(false);
    
    // æ¸¬è©¦æˆåŠŸæ¡ˆä¾‹
    User librarian = userService.registerLibrarian("librarian", "test@example.com", "password", "Test Librarian", "valid-id");
    assertNotNull(librarian);
    
    // æ¸¬è©¦å¤±æ•—æ¡ˆä¾‹
    assertThrows(RuntimeException.class, () -> {
        userService.registerLibrarian("librarian2", "test2@example.com", "password", "Test Librarian 2", "invalid-id");
    });
}
```

---

## ğŸ¯ **æœ€ä½³å¯¦è¸**

### **1. é…ç½®ç®¡ç†**

- âœ… ä½¿ç”¨é…ç½®æª”æ¡ˆç®¡ç†å¤–éƒ¨APIåƒæ•¸
- âœ… æä¾›é è¨­å€¼é¿å…é…ç½®ç¼ºå¤±
- âœ… ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†æ•æ„Ÿè³‡è¨Š

### **2. éŒ¯èª¤è™•ç†**

- âœ… æ•ç²æ‰€æœ‰å¯èƒ½çš„ç•°å¸¸
- âœ… æä¾›æœ‰æ„ç¾©çš„éŒ¯èª¤è¨Šæ¯
- âœ… è¨˜éŒ„è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ

### **3. æ•ˆèƒ½å„ªåŒ–**

- âœ… è¨­å®šé©ç•¶çš„è¶…æ™‚æ™‚é–“
- âœ… è€ƒæ…®ä½¿ç”¨å¿«å–æ©Ÿåˆ¶
- âœ… ç›£æ§å¤–éƒ¨APIçš„éŸ¿æ‡‰æ™‚é–“

### **4. å®‰å…¨æ€§**

- âœ… ä¸è¦åœ¨æ—¥èªŒä¸­è¨˜éŒ„æ•æ„Ÿè³‡è¨Š
- âœ… ä½¿ç”¨HTTPSé€²è¡Œå®‰å…¨é€šè¨Š
- âœ… é©—è­‰å¤–éƒ¨APIçš„å›æ‡‰

---

## ğŸ“Š **ç¸½çµ**

### **å¤–éƒ¨APIæ•´åˆçš„æ ¸å¿ƒè¦ç´ **

1. **RestTemplate** - HTTPå®¢æˆ¶ç«¯å·¥å…·
2. **é…ç½®ç®¡ç†** - å¤–éƒ¨åƒæ•¸çš„é›†ä¸­ç®¡ç†
3. **éŒ¯èª¤è™•ç†** - å„ªé›…çš„ç•°å¸¸è™•ç†
4. **å®‰å…¨æ€§** - ä¿è­·æ•æ„Ÿè³‡è¨Š
5. **æ¸¬è©¦** - å®Œæ•´çš„æ¸¬è©¦è¦†è“‹

### **å­¸ç¿’æª¢æŸ¥æ¸…å–®**

- [ ] äº†è§£å¤–éƒ¨APIæ•´åˆçš„ç›®çš„
- [ ] æŒæ¡RestTemplateçš„ä½¿ç”¨æ–¹æ³•
- [ ] å­¸æœƒé…ç½®ç®¡ç†çš„æœ€ä½³å¯¦è¸
- [ ] ç†è§£éŒ¯èª¤è™•ç†çš„é‡è¦æ€§
- [ ] èƒ½å¤ ç·¨å¯«å¤–éƒ¨APIæ•´åˆçš„æ¸¬è©¦

---

**ç¾åœ¨æ‚¨å·²ç¶“äº†è§£äº†å¤–éƒ¨APIæ•´åˆçš„æ ¸å¿ƒæ¦‚å¿µå’Œå¯¦ä½œæ–¹æ³•ï¼**
