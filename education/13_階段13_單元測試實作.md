# éšæ®µ13: å–®å…ƒæ¸¬è©¦å¯¦ä½œ
## Library Management System - Unit Testing Implementation

---

### ğŸ“‹ **ç›®éŒ„**
1. [æ¸¬è©¦æ¶æ§‹æ¦‚è¿°](#æ¸¬è©¦æ¶æ§‹æ¦‚è¿°)
2. [æ¸¬è©¦å¥—ä»¶èˆ‡ä¾è³´](#æ¸¬è©¦å¥—ä»¶èˆ‡ä¾è³´)
3. [Service Layer æ¸¬è©¦](#service-layer-æ¸¬è©¦)
4. [Repository Layer æ¸¬è©¦](#repository-layer-æ¸¬è©¦)
5. [Controller Layer æ¸¬è©¦](#controller-layer-æ¸¬è©¦)
6. [æ¸¬è©¦é…ç½®èˆ‡è¨­å®š](#æ¸¬è©¦é…ç½®èˆ‡è¨­å®š)
7. [æœ€ä½³å¯¦è¸èˆ‡æ³¨æ„äº‹é …](#æœ€ä½³å¯¦è¸èˆ‡æ³¨æ„äº‹é …)
8. [åŸ·è¡Œæ¸¬è©¦èˆ‡è¦†è“‹ç‡](#åŸ·è¡Œæ¸¬è©¦èˆ‡è¦†è“‹ç‡)

---

## ğŸ—ï¸ **æ¸¬è©¦æ¶æ§‹æ¦‚è¿°**

### **ä¸‰å±¤æ¸¬è©¦æ¶æ§‹**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller Testsâ”‚ â† API ç«¯é»æ¸¬è©¦ (MockMvc)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service Tests   â”‚ â† æ¥­å‹™é‚è¼¯æ¸¬è©¦ (Mockito)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Repository Testsâ”‚ â† è³‡æ–™åº«æ“ä½œæ¸¬è©¦ (H2)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **æ¸¬è©¦ç­–ç•¥**
- **Service Layer**: ä½¿ç”¨ Mockito æ¨¡æ“¬ä¾è³´
- **Repository Layer**: ä½¿ç”¨ H2 è¨˜æ†¶é«”è³‡æ–™åº«
- **Controller Layer**: ä½¿ç”¨ MockMvc æ¨¡æ“¬ HTTP è«‹æ±‚

---

## ğŸ“¦ **æ¸¬è©¦å¥—ä»¶èˆ‡ä¾è³´**

### **Maven ä¾è³´ (pom.xml)**
```xml
<!-- JUnit 5 -->
<dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter</artifactId>
    <scope>test</scope>
</dependency>

<!-- Spring Boot Test -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>

<!-- Mockito -->
<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-core</artifactId>
    <scope>test</scope>
</dependency>

<!-- H2 Database -->
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>

<!-- JaCoCo Coverage -->
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.11</version>
</plugin>
```

### **æ ¸å¿ƒå¥—ä»¶èªªæ˜**
- **JUnit 5**: æ¸¬è©¦æ¡†æ¶
- **Mockito**: æ¨¡æ“¬æ¡†æ¶
- **Spring Boot Test**: Spring æ•´åˆæ¸¬è©¦
- **H2**: è¨˜æ†¶é«”è³‡æ–™åº«
- **JaCoCo**: ç¨‹å¼ç¢¼è¦†è“‹ç‡

---

## ğŸ§ª **Service Layer æ¸¬è©¦**

### **Service æ¸¬è©¦æ¦‚è¿°**
Service å±¤æ¸¬è©¦ä½¿ç”¨ Mockito æ¡†æ¶ï¼Œä¸»è¦æ¸¬è©¦æ¥­å‹™é‚è¼¯ï¼Œä¸å•Ÿå‹• Spring å®¹å™¨ï¼ŒåŸ·è¡Œé€Ÿåº¦å¿«ã€‚

### **æ ¸å¿ƒæ¦‚å¿µ**
- **ç´”å–®å…ƒæ¸¬è©¦**: ä¸å•Ÿå‹• Spring å®¹å™¨
- **ä¾è³´éš”é›¢**: ä½¿ç”¨ Mock æ¨¡æ“¬æ‰€æœ‰å¤–éƒ¨ä¾è³´
- **å¿«é€ŸåŸ·è¡Œ**: ç„¡è³‡æ–™åº«æ“ä½œï¼ŒåŸ·è¡Œæ™‚é–“çŸ­
- **æ¥­å‹™é‚è¼¯é©—è­‰**: å°ˆæ³¨æ–¼æ¥­å‹™è¦å‰‡å’Œæµç¨‹

### **æ¸¬è©¦çµæ§‹**
```java
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private RoleRepository roleRepository;
    
    @InjectMocks
    private UserService userService;
    
    @BeforeEach
    void setUp() {
        // åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™
    }
    
    @Test
    void testMethodName_Scenario() {
        // Arrange - æº–å‚™æ¸¬è©¦è³‡æ–™
        // Act - åŸ·è¡Œè¢«æ¸¬è©¦æ–¹æ³•
        // Assert - é©—è­‰çµæœ
    }
}
```

### **å¸¸ç”¨ Mockito æ–¹æ³•**

#### **Mock è¨­å®š**
```java
// åŸºæœ¬ Mock
when(userRepository.findById(1L)).thenReturn(Optional.of(user));

// åƒæ•¸åŒ¹é…
when(userRepository.findByEmail(anyString())).thenReturn(Optional.of(user));

// æ‹‹å‡ºä¾‹å¤–
when(userRepository.findById(999L))
    .thenThrow(new RuntimeException("User not found"));

// Void æ–¹æ³•
doNothing().when(userRepository).delete(user);
```

#### **é©—è­‰æ–¹æ³•**
```java
// é©—è­‰æ–¹æ³•è¢«å‘¼å«
verify(userRepository).findById(1L);

// é©—è­‰æ–¹æ³•è¢«å‘¼å«ç‰¹å®šæ¬¡æ•¸
verify(userRepository, times(1)).findById(1L);

// é©—è­‰æ–¹æ³•å¾æœªè¢«å‘¼å«
verify(userRepository, never()).delete(any());

// é©—è­‰æ–¹æ³•è¢«å‘¼å«ä¸”åƒæ•¸æ­£ç¢º
verify(userRepository).save(argThat(user -> 
    user.getName().equals("John Doe")
));
```

### **Service æ¸¬è©¦æœ€ä½³å¯¦è¸**

#### **æ¨™æº–æ¸¬è©¦çµæ§‹**
```java
@ExtendWith(MockitoExtension.class)
class ServiceTest {
    
    @Mock
    private Repository repository;
    
    @Mock
    private ExternalService externalService;
    
    @InjectMocks
    private Service service;
    
    private TestEntity testEntity;
    
    @BeforeEach
    void setUp() {
        // å»ºç«‹æ¸¬è©¦è³‡æ–™
        testEntity = new TestEntity();
        testEntity.setId(1L);
        testEntity.setName("Test Entity");
        
        // Reset mocks
        reset(repository, externalService);
    }
    
    @Test
    @DisplayName("Test method - Success scenario")
    void testMethod_Success() {
        // Arrange
        when(repository.findById(1L)).thenReturn(Optional.of(testEntity));
        when(repository.save(any(TestEntity.class))).thenReturn(testEntity);
        
        // Act
        TestEntity result = service.method(1L);
        
        // Assert
        assertNotNull(result);
        assertEquals(testEntity.getId(), result.getId());
        assertEquals(testEntity.getName(), result.getName());
        
        // Verify interactions
        verify(repository).findById(1L);
        verify(repository).save(any(TestEntity.class));
    }
    
    @Test
    @DisplayName("Test method - Error scenario")
    void testMethod_Error() {
        // Arrange
        when(repository.findById(999L)).thenReturn(Optional.empty());
        
        // Act & Assert
        RuntimeException exception = assertThrows(RuntimeException.class, () -> {
            service.method(999L);
        });
        
        assertEquals("Entity not found", exception.getMessage());
        verify(repository).findById(999L);
        verifyNoMoreInteractions(repository);
    }
}
```

#### **Service æ¸¬è©¦ç¯„ä¾‹ - ç”¨æˆ¶è¨»å†Š**
```java
@Test
@DisplayName("Test register user - Success")
void testRegisterUser_Success() {
    // Arrange
    String name = "Jane Smith";
    String email = "jane@example.com";
    String password = "password123";
    String encodedPassword = "encodedPassword123";
    Role memberRole = new Role(1L, "MEMBER");
    
    when(userRepository.existsByEmail(email)).thenReturn(false);
    when(roleRepository.findByName("MEMBER")).thenReturn(Optional.of(memberRole));
    when(passwordEncoder.encode(password)).thenReturn(encodedPassword);
    
    // Create expected user with correct values
    User expectedUser = new User();
    expectedUser.setId(1L);
    expectedUser.setName(name);
    expectedUser.setEmail(email);
    expectedUser.setPassword(encodedPassword);
    expectedUser.setRole(memberRole);
    expectedUser.setIsVerified(false);
    when(userRepository.save(any(User.class))).thenReturn(expectedUser);
    
    // Act
    User result = userService.registerUser(name, email, password);
    
    // Assert
    assertNotNull(result);
    assertEquals(name, result.getName());
    assertEquals(email, result.getEmail());
    assertEquals(encodedPassword, result.getPassword());
    assertEquals(memberRole, result.getRole());
    assertFalse(result.getIsVerified());
    
    // Verify interactions
    verify(userRepository).existsByEmail(email);
    verify(roleRepository).findByName("MEMBER");
    verify(passwordEncoder).encode(password);
    verify(userRepository).save(any(User.class));
}
```

#### **Service æ¸¬è©¦ç¯„ä¾‹ - é¤¨å“¡è¨»å†Šï¼ˆå«å¤–éƒ¨ APIï¼‰**
```java
@Test
@DisplayName("Test register librarian - Success")
void testRegisterLibrarian_Success() {
    // Arrange
    String name = "Librarian Admin";
    String email = "librarian@library.com";
    String password = "password123";
    String librarianId = "LIB001";
    String encodedPassword = "encodedPassword123";
    Role librarianRole = new Role(2L, "LIBRARIAN");
    
    when(userRepository.existsByEmail(email)).thenReturn(false);
    when(roleRepository.findByName("LIBRARIAN")).thenReturn(Optional.of(librarianRole));
    when(passwordEncoder.encode(password)).thenReturn(encodedPassword);
    when(externalApiService.verifyLibrarian(librarianId)).thenReturn(true);
    
    // Create expected user with correct values
    User expectedUser = new User();
    expectedUser.setId(1L);
    expectedUser.setName(name);
    expectedUser.setEmail(email);
    expectedUser.setPassword(encodedPassword);
    expectedUser.setRole(librarianRole);
    expectedUser.setLibrarianId(librarianId);
    expectedUser.setIsVerified(true);
    when(userRepository.save(any(User.class))).thenReturn(expectedUser);
    
    // Act
    User result = userService.registerLibrarian(name, email, password, librarianId);
    
    // Assert
    assertNotNull(result);
    assertEquals(name, result.getName());
    assertEquals(email, result.getEmail());
    assertEquals(librarianRole, result.getRole());
    assertEquals(librarianId, result.getLibrarianId());
    assertTrue(result.getIsVerified());
    
    // Verify interactions
    verify(userRepository).existsByEmail(email);
    verify(roleRepository).findByName("LIBRARIAN");
    verify(passwordEncoder).encode(password);
    verify(externalApiService).verifyLibrarian(librarianId);
    verify(userRepository).save(any(User.class));
}
```

---

## ğŸ—„ï¸ **Repository Layer æ¸¬è©¦**

### **Repository æ¸¬è©¦æ¦‚è¿°**
Repository å±¤æ¸¬è©¦ä½¿ç”¨ `@DataJpaTest` è¨»è§£ï¼Œå•Ÿå‹• H2 è¨˜æ†¶é«”è³‡æ–™åº«ï¼Œæ¸¬è©¦çœŸå¯¦çš„è³‡æ–™åº«æ“ä½œã€‚

### **æ ¸å¿ƒæ¦‚å¿µ**
- **æ•´åˆæ¸¬è©¦**: å•Ÿå‹• JPA å’Œ H2 è³‡æ–™åº«
- **çœŸå¯¦è³‡æ–™åº«æ“ä½œ**: æ¸¬è©¦ SQL æŸ¥è©¢å’Œè³‡æ–™æŒä¹…åŒ–
- **è³‡æ–™éš”é›¢**: æ¯å€‹æ¸¬è©¦æ–¹æ³•ä½¿ç”¨ç¨ç«‹çš„è³‡æ–™
- **é—œè¯æ¸¬è©¦**: æ¸¬è©¦ Entity ä¹‹é–“çš„é—œè¯é—œä¿‚

### **ç›¸é—œå¥—ä»¶èˆ‡ä¾è³´**

#### **Spring Boot Test å¥—ä»¶**
```xml
<!-- Spring Boot Test Starter -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>

<!-- H2 Database -->
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```

#### **æ ¸å¿ƒè¨»è§£èªªæ˜**
- **`@DataJpaTest`**: å•Ÿå‹• JPA ç›¸é—œçµ„ä»¶ï¼Œä¸å•Ÿå‹• Web å±¤
- **`@TestEntityManager`**: æä¾›æ¸¬è©¦ç”¨çš„ EntityManager
- **`@ActiveProfiles("test")`**: å•Ÿç”¨æ¸¬è©¦é…ç½®æª”æ¡ˆ
- **`@Transactional`**: æ¸¬è©¦æ–¹æ³•è‡ªå‹•å›æ»¾ï¼ˆå¯é¸ï¼‰

### **H2 è¨˜æ†¶é«”è³‡æ–™åº«ä½¿ç”¨**

#### **H2 ç‰¹æ€§**
```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  
  h2:
    console:
      enabled: true
      path: /h2-console
  
  jpa:
    hibernate:
      ddl-auto: create-drop  # æ¯æ¬¡æ¸¬è©¦é‡æ–°å»ºç«‹è¡¨çµæ§‹
    show-sql: false          # é—œé–‰ SQL æ—¥èªŒï¼ˆæ¸¬è©¦æ™‚ï¼‰
    properties:
      hibernate:
        format_sql: false
        dialect: org.hibernate.dialect.H2Dialect
```

#### **H2 è¨˜æ†¶é«”æ¨¡å¼å„ªå‹¢**
- **å¿«é€Ÿå•Ÿå‹•**: ç„¡éœ€å¤–éƒ¨è³‡æ–™åº«
- **éš”é›¢æ€§**: æ¯å€‹æ¸¬è©¦ä½¿ç”¨ç¨ç«‹çš„è³‡æ–™åº«å¯¦ä¾‹
- **è‡ªå‹•æ¸…ç†**: æ¸¬è©¦çµæŸå¾Œè‡ªå‹•æ¸…ç†è³‡æ–™
- **ç„¡é…ç½®**: ç„¡éœ€é¡å¤–çš„è³‡æ–™åº«è¨­å®š

### **Repository æ¸¬è©¦çµæ§‹**

#### **åŸºæœ¬æ¸¬è©¦çµæ§‹**
```java
@DataJpaTest
@ActiveProfiles("test")
public class UserRepositoryTest {

    @Autowired
    private TestEntityManager entityManager;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private RoleRepository roleRepository;

    private Role memberRole;
    private Role librarianRole;
    private User testUser1;
    private User testUser2;

    @BeforeEach
    void setUp() {
        // æ¸…ç†è³‡æ–™åº«
        entityManager.clear();

        // å»ºç«‹æ¸¬è©¦è§’è‰²
        memberRole = new Role();
        memberRole.setName("MEMBER");
        memberRole = entityManager.persistAndFlush(memberRole);

        librarianRole = new Role();
        librarianRole.setName("LIBRARIAN");
        librarianRole = entityManager.persistAndFlush(librarianRole);

        // å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…
        testUser1 = new User();
        testUser1.setName("John Doe");
        testUser1.setEmail("john@example.com");
        testUser1.setPassword("encodedPassword1");
        testUser1.setRole(memberRole);
        testUser1.setIsVerified(false);
        testUser1 = entityManager.persistAndFlush(testUser1);

        testUser2 = new User();
        testUser2.setName("Jane Smith");
        testUser2.setEmail("jane@example.com");
        testUser2.setPassword("encodedPassword2");
        testUser2.setRole(librarianRole);
        testUser2.setIsVerified(true);
        testUser2.setLibrarianId("LIB001");
        testUser2 = entityManager.persistAndFlush(testUser2);

        entityManager.flush();
    }
}
```

### **Hibernate è‡ªå‹•é—œè¯å»ºç«‹**

#### **é—œè¯å»ºç«‹æ©Ÿåˆ¶**
```java
// Hibernate æœƒè‡ªå‹•å»ºç«‹ï¼š
// 1. æ‰€æœ‰ Entity å°æ‡‰çš„è³‡æ–™è¡¨
// 2. å¤–éµç´„æŸå’Œé—œè¯è¡¨
// 3. ç´¢å¼•å’Œç´„æŸ

@Entity
@Table(name = "users")
public class User {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "role_id")
    private Role role;
    
    @OneToMany(mappedBy = "user", fetch = FetchType.LAZY)
    private List<BorrowRecord> borrowRecords;
}

// Hibernate æœƒå»ºç«‹ï¼š
// - users è¡¨
// - roles è¡¨  
// - borrow_records è¡¨
// - å¤–éµç´„æŸï¼šusers.role_id -> roles.id
// - å¤–éµç´„æŸï¼šborrow_records.user_id -> users.id
```

#### **é—œè¯å»ºç«‹çš„å½±éŸ¿**
- **å„ªé»**: è‡ªå‹•è™•ç†è¤‡é›œçš„é—œè¯é—œä¿‚
- **ç¼ºé»**: æ¸¬è©¦å•Ÿå‹•æ™‚é–“è¼ƒé•·
- **æ³¨æ„**: æ¯å€‹æ¸¬è©¦é¡éƒ½æœƒé‡æ–°å»ºç«‹å®Œæ•´çš„è³‡æ–™åº«çµæ§‹

### **Repository æ¸¬è©¦ç¯„ä¾‹**

#### **åŸºæœ¬ CRUD æ“ä½œæ¸¬è©¦**
```java
@Test
@DisplayName("Test find by email - Success")
void testFindByEmail_Success() {
    // Act
    Optional<User> result = userRepository.findByEmail("john@example.com");

    // Assert
    assertTrue(result.isPresent());
    assertEquals("John Doe", result.get().getName());
    assertEquals("john@example.com", result.get().getEmail());
    assertEquals("MEMBER", result.get().getRole().getName());
}

@Test
@DisplayName("Test find by email - Not found")
void testFindByEmail_NotFound() {
    // Act
    Optional<User> result = userRepository.findByEmail("nonexistent@example.com");

    // Assert
    assertFalse(result.isPresent());
}

@Test
@DisplayName("Test save new user")
void testSave_NewUser() {
    // Arrange
    User newUser = new User();
    newUser.setName("New User");
    newUser.setEmail("new@example.com");
    newUser.setPassword("encodedPassword");
    newUser.setRole(memberRole);
    newUser.setIsVerified(false);

    // Act
    User savedUser = userRepository.save(newUser);

    // Assert
    assertNotNull(savedUser.getId());
    assertEquals("New User", savedUser.getName());
    assertEquals("new@example.com", savedUser.getEmail());
    assertEquals("MEMBER", savedUser.getRole().getName());
    assertFalse(savedUser.getIsVerified());
}
```

#### **è¤‡é›œæŸ¥è©¢æ¸¬è©¦**
```java
@Test
@DisplayName("Test find by role with join fetch")
void testFindByEmailWithRole_Success() {
    // Act
    Optional<User> result = userRepository.findByEmailWithRole("jane@example.com");

    // Assert
    assertTrue(result.isPresent());
    assertEquals("Jane Smith", result.get().getName());
    assertEquals("LIBRARIAN", result.get().getRole().getName());
    assertTrue(result.get().getIsVerified());
}

@Test
@DisplayName("Test search users with multiple criteria")
void testSearchUsers_MultipleCriteria() {
    // Act
    List<User> results = userRepository.searchUsers("John", "john@example.com", "MEMBER");

    // Assert
    assertEquals(1, results.size());
    assertEquals("John Doe", results.get(0).getName());
    assertEquals("john@example.com", results.get(0).getEmail());
    assertEquals("MEMBER", results.get(0).getRole().getName());
}
```

### **BookType å¸¸æ•¸ä½¿ç”¨**

#### **æ­£ç¢ºçš„å¸¸æ•¸ä½¿ç”¨æ–¹å¼**
```java
import com.library.constant.BookType;

@BeforeEach
void setUp() {
    // å»ºç«‹æ¸¬è©¦æ›¸ç±
    testBook1 = new Book();
    testBook1.setTitle("Java Programming");
    testBook1.setAuthor("John Smith");
    testBook1.setPublishedYear(2023);
    testBook1.setCategory("Programming");
    testBook1.setBookType(BookType.TRADITIONAL);  // ä½¿ç”¨å¸¸æ•¸
    testBook1 = entityManager.persistAndFlush(testBook1);

    testBook2 = new Book();
    testBook2.setTitle("Python for Beginners");
    testBook2.setAuthor("Jane Doe");
    testBook2.setPublishedYear(2022);
    testBook2.setCategory("Programming");
    testBook2.setBookType(BookType.MODERN);       // ä½¿ç”¨å¸¸æ•¸
    testBook2 = entityManager.persistAndFlush(testBook2);
}
```

#### **å¸¸æ•¸ä½¿ç”¨çš„å¥½è™•**
- **é¡å‹å®‰å…¨**: é¿å…æ‹¼å¯«éŒ¯èª¤
- **ç¶­è­·æ€§**: å¸¸æ•¸å€¼æ”¹è®Šæ™‚åªéœ€ä¿®æ”¹ä¸€è™•
- **ä¸€è‡´æ€§**: ç¢ºä¿æ‰€æœ‰æ¸¬è©¦ä½¿ç”¨ç›¸åŒçš„å€¼
- **å¯è®€æ€§**: å¸¸æ•¸åç¨±æ¯”å­—ä¸²æ›´æ¸…æ¥š

### **Repository æ¸¬è©¦æœ€ä½³å¯¦è¸**

#### **1. è³‡æ–™éš”é›¢**
```java
@BeforeEach
void setUp() {
    // æ¸…ç†è³‡æ–™åº«
    entityManager.clear();
    
    // å»ºç«‹æ¸¬è©¦è³‡æ–™
    // ...
    
    // ç¢ºä¿è³‡æ–™æŒä¹…åŒ–
    entityManager.flush();
}
```

#### **2. æ¸¬è©¦æ–¹æ³•å‘½å**
```java
// æ ¼å¼ï¼štestMethodName_Scenario
@Test
void testFindByEmail_Success() { }
@Test
void testFindByEmail_NotFound() { }
@Test
void testSave_NewUser() { }
@Test
void testSave_UpdateUser() { }
```

#### **3. æ¸¬è©¦è³‡æ–™ç®¡ç†**
```java
// ä½¿ç”¨ TestEntityManager ç²¾ç¢ºæ§åˆ¶
entityManager.persistAndFlush(entity);  // ç«‹å³æŒä¹…åŒ–
entityManager.clear();                  // æ¸…ç†å¿«å–
entityManager.flush();                  // å¼·åˆ¶åŒæ­¥
```

#### **4. é—œè¯æ¸¬è©¦**
```java
@Test
void testUserWithRole() {
    // æ¸¬è©¦é—œè¯æŸ¥è©¢
    Optional<User> user = userRepository.findByEmailWithRole("john@example.com");
    
    assertTrue(user.isPresent());
    assertNotNull(user.get().getRole());  // ç¢ºä¿é—œè¯å·²è¼‰å…¥
    assertEquals("MEMBER", user.get().getRole().getName());
}
```

### **Repository æ¸¬è©¦æ³¨æ„äº‹é …**

#### **1. å•Ÿå‹•æ™‚é–“**
- **Repository æ¸¬è©¦å•Ÿå‹•è¼ƒæ…¢**: éœ€è¦åˆå§‹åŒ– H2 è³‡æ–™åº«å’Œ JPA
- **æ¯å€‹æ¸¬è©¦é¡ç¨ç«‹å•Ÿå‹•**: é¿å…ä½¿ç”¨æ¸¬è©¦å¥—ä»¶ä¾†æ¸›å°‘å•Ÿå‹•æ¬¡æ•¸
- **é—œè¯å»ºç«‹é–‹éŠ·**: Hibernate æœƒå»ºç«‹å®Œæ•´çš„è³‡æ–™åº«çµæ§‹

#### **2. è³‡æ–™éš”é›¢**
- **ä½¿ç”¨ `@BeforeEach` æ¸…ç†**: ç¢ºä¿æ¯å€‹æ¸¬è©¦ä½¿ç”¨ä¹¾æ·¨çš„è³‡æ–™
- **é¿å…æ¸¬è©¦é–“ä¾è³´**: æ¯å€‹æ¸¬è©¦æ‡‰è©²ç¨ç«‹åŸ·è¡Œ
- **ä½¿ç”¨ `TestEntityManager`**: ç²¾ç¢ºæ§åˆ¶è³‡æ–™çš„ç”Ÿå‘½é€±æœŸ

#### **3. æ€§èƒ½å„ªåŒ–**
- **é—œé–‰ä¸å¿…è¦çš„åŠŸèƒ½**: åœ¨æ¸¬è©¦é…ç½®ä¸­é—œé–‰ SQL æ—¥èªŒ
- **ä½¿ç”¨è¨˜æ†¶é«”æ¨¡å¼**: H2 è¨˜æ†¶é«”æ¨¡å¼æ¯”æª”æ¡ˆæ¨¡å¼å¿«
- **æ‰¹é‡æ“ä½œ**: å°æ–¼å¤§é‡è³‡æ–™æ¸¬è©¦ï¼Œè€ƒæ…®ä½¿ç”¨æ‰¹é‡æ“ä½œ

#### **4. æ¸¬è©¦è¦†è“‹**
- **CRUD æ“ä½œ**: æ¸¬è©¦æ‰€æœ‰åŸºæœ¬çš„å¢åˆªæ”¹æŸ¥æ“ä½œ
- **æŸ¥è©¢æ–¹æ³•**: æ¸¬è©¦è‡ªå®šç¾©çš„æŸ¥è©¢æ–¹æ³•
- **é‚Šç•Œæ¢ä»¶**: æ¸¬è©¦ç©ºçµæœã€ç•°å¸¸æƒ…æ³
- **é—œè¯æŸ¥è©¢**: æ¸¬è©¦ Entity ä¹‹é–“çš„é—œè¯é—œä¿‚

### **Repository æ¸¬è©¦èˆ‡ Service æ¸¬è©¦çš„å€åˆ¥**

| ç‰¹æ€§ | Repository æ¸¬è©¦ | Service æ¸¬è©¦ |
|------|----------------|-------------|
| **æ¸¬è©¦ç¯„åœ** | è³‡æ–™åº«æ“ä½œ | æ¥­å‹™é‚è¼¯ |
| **å•Ÿå‹•çµ„ä»¶** | JPA + H2 | ç„¡ (ç´” Mock) |
| **åŸ·è¡Œé€Ÿåº¦** | æ…¢ (5-10ç§’) | å¿« (1-2ç§’) |
| **ä¾è³´è™•ç†** | çœŸå¯¦è³‡æ–™åº« | Mock æ¨¡æ“¬ |
| **æ¸¬è©¦é‡é»** | SQL æŸ¥è©¢ã€è³‡æ–™æŒä¹…åŒ– | æ¥­å‹™è¦å‰‡ã€æµç¨‹æ§åˆ¶ |
| **éš”é›¢æ€§** | è³‡æ–™åº«å±¤éš”é›¢ | æ–¹æ³•å±¤éš”é›¢ |
    assertEquals(librarianId, result.getLibrarianId());
    assertTrue(result.getIsVerified());
    
    // Verify interactions
    verify(userRepository).existsByEmail(email);
    verify(roleRepository).findByName("LIBRARIAN");
    verify(passwordEncoder).encode(password);
    verify(externalApiService).verifyLibrarian(librarianId);
    verify(userRepository).save(any(User.class));
}
```

#### **Service æ¸¬è©¦ç¯„ä¾‹ - å€Ÿæ›¸æ¥­å‹™é‚è¼¯**
```java
@Test
@DisplayName("Test borrow book - Success")
void testBorrowBook_Success() {
    // Arrange
    User testUser = new User();
    testUser.setId(1L);
    testUser.setName("Test User");
    
    BookCopy testBookCopy = new BookCopy();
    testBookCopy.setId(1L);
    testBookCopy.setStatus("AVAILABLE");
    
    when(userRepository.findById(1L)).thenReturn(Optional.of(testUser));
    when(bookCopyRepository.findById(1L)).thenReturn(Optional.of(testBookCopy));
    when(borrowRecordRepository.findByUserAndStatus(testUser, "BORROWED"))
        .thenReturn(Arrays.asList());
    when(borrowRecordRepository.save(any(BorrowRecord.class)))
        .thenReturn(new BorrowRecord());
    when(bookCopyRepository.save(any(BookCopy.class)))
        .thenReturn(testBookCopy);
    
    // Act
    BorrowRecord result = borrowService.borrowBook(1L, 1L);
    
    // Assert
    assertNotNull(result);
    assertEquals(testUser, result.getUser());
    assertEquals(testBookCopy, result.getBookCopy());
    
    // Verify interactions
    verify(userRepository).findById(1L);
    verify(bookCopyRepository).findById(1L);
    verify(borrowRecordRepository).findByUserAndStatus(testUser, "BORROWED");
    verify(borrowRecordRepository).save(any(BorrowRecord.class));
    verify(bookCopyRepository).save(any(BookCopy.class));
}
```

---

## ğŸ—„ï¸ **Repository Layer æ¸¬è©¦**

### **æ¸¬è©¦çµæ§‹**
```java
@DataJpaTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @BeforeEach
    void setUp() {
        // æ¸…ç†è³‡æ–™åº«ä¸¦æº–å‚™æ¸¬è©¦è³‡æ–™
        entityManager.clear();
    }
    
    @Test
    void testMethodName_Scenario() {
        // ä½¿ç”¨ TestEntityManager å»ºç«‹æ¸¬è©¦è³‡æ–™
        // åŸ·è¡Œ Repository æ–¹æ³•
        // é©—è­‰çµæœ
    }
}
```

### **TestEntityManager ä½¿ç”¨**
```java
// å»ºç«‹æ¸¬è©¦å¯¦é«”
User user = new User("John Doe", "password", "john@example.com", role);
User savedUser = entityManager.persistAndFlush(user);

// æŸ¥è©¢å¯¦é«”
User foundUser = entityManager.find(User.class, savedUser.getId());

// æ¸…ç†è³‡æ–™
entityManager.clear();
```

### **Repository æ¸¬è©¦ç¯„ä¾‹**
```java
@Test
void testFindByEmail_Success() {
    // Arrange
    Role role = entityManager.persistAndFlush(new Role("MEMBER"));
    User user = new User("John Doe", "password", "john@example.com", role);
    entityManager.persistAndFlush(user);
    
    // Act
    Optional<User> result = userRepository.findByEmail("john@example.com");
    
    // Assert
    assertTrue(result.isPresent());
    assertEquals("John Doe", result.get().getName());
    assertEquals("john@example.com", result.get().getEmail());
}
```

---

## ğŸŒ **Controller Layer æ¸¬è©¦**

### **æ¸¬è©¦çµæ§‹**
```java
@WebMvcTest(UserController.class)
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    @WithMockUser(username = "user@example.com", roles = "MEMBER")
    void testMethodName_Scenario() throws Exception {
        // ä½¿ç”¨ MockMvc æ¨¡æ“¬ HTTP è«‹æ±‚
        // é©—è­‰å›æ‡‰ç‹€æ…‹å’Œå…§å®¹
    }
}
```

### **MockMvc ä½¿ç”¨**

#### **HTTP è«‹æ±‚æ¨¡æ“¬**
```java
// GET è«‹æ±‚
mockMvc.perform(get("/users/1"))
    .andExpect(status().isOk())
    .andExpect(jsonPath("$.success").value(true));

// POST è«‹æ±‚
mockMvc.perform(post("/users")
    .contentType(MediaType.APPLICATION_JSON)
    .content(objectMapper.writeValueAsString(request)))
    .andExpect(status().isCreated());

// PUT è«‹æ±‚
mockMvc.perform(put("/users/1")
    .contentType(MediaType.APPLICATION_JSON)
    .content(objectMapper.writeValueAsString(request)))
    .andExpect(status().isOk());

// DELETE è«‹æ±‚
mockMvc.perform(delete("/users/1"))
    .andExpect(status().isOk());
```

#### **JSON è·¯å¾‘é©—è­‰**
```java
// é©—è­‰ JSON å›æ‡‰
.andExpect(jsonPath("$.success").value(true))
.andExpect(jsonPath("$.data.id").value(1))
.andExpect(jsonPath("$.data.name").value("John Doe"))
.andExpect(jsonPath("$.data").isArray())
.andExpect(jsonPath("$.data").isEmpty())
```

#### **æ¬Šé™æ¸¬è©¦**
```java
// æ¸¬è©¦ä¸åŒè§’è‰²çš„æ¬Šé™
@Test
@WithMockUser(username = "librarian@library.com", roles = "LIBRARIAN")
void testCreateBook_LibrarianAccess() throws Exception {
    // é¤¨å“¡å¯ä»¥å­˜å–
}

@Test
@WithMockUser(username = "member@example.com", roles = "MEMBER")
void testCreateBook_MemberAccessDenied() throws Exception {
    // ä¸€èˆ¬æœƒå“¡ç„¡æ³•å­˜å–
    .andExpect(status().isForbidden());
}
```

### **Controller æ¸¬è©¦ç¯„ä¾‹**
```java
@Test
@WithMockUser(username = "john@example.com", roles = "MEMBER")
void testGetCurrentUser_Success() throws Exception {
    // Arrange
    User user = new User(1L, "John Doe", "john@example.com", role);
    when(userService.findByEmail("john@example.com"))
        .thenReturn(Optional.of(user));
    
    // Act & Assert
    mockMvc.perform(get("/users/current"))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.success").value(true))
        .andExpect(jsonPath("$.data.id").value(1))
        .andExpect(jsonPath("$.data.name").value("John Doe"));
    
    verify(userService).findByEmail("john@example.com");
}
```

---

## âš™ï¸ **æ¸¬è©¦é…ç½®èˆ‡è¨­å®š**

### **application-test.yml**
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.H2Dialect
  
  h2:
    console:
      enabled: true
      path: /h2-console

# JWT æ¸¬è©¦é…ç½®
jwt:
  secret: testSecretKeyForTestingPurposesOnlyDoNotUseInProduction
  expiration: 86400000

# é—œé–‰ CSRF ä¿è­· (æ¸¬è©¦ç”¨)
spring:
  security:
    csrf:
      enabled: false
```

### **æ¸¬è©¦ Profile ä½¿ç”¨**
```java
@ActiveProfiles("test")
@SpringBootTest
class IntegrationTest {
    // ä½¿ç”¨æ¸¬è©¦é…ç½®
}
```

---

## ğŸ“ **æœ€ä½³å¯¦è¸èˆ‡æ³¨æ„äº‹é …**

### **æ¸¬è©¦å‘½åè¦ç¯„**
```java
// æ ¼å¼: testMethodName_Scenario
void testRegisterUser_Success()
void testRegisterUser_EmailAlreadyExists()
void testRegisterUser_InvalidPassword()
void testGetUserById_NotFound()
void testUpdateUser_AccessDenied()
```

### **AAA æ¨¡å¼ (Arrange-Act-Assert)**
```java
@Test
void testMethodName_Scenario() {
    // Arrange - æº–å‚™æ¸¬è©¦è³‡æ–™å’Œ Mock
    User user = new User("John Doe", "john@example.com");
    when(userRepository.save(any())).thenReturn(user);
    
    // Act - åŸ·è¡Œè¢«æ¸¬è©¦æ–¹æ³•
    User result = userService.createUser(user);
    
    // Assert - é©—è­‰çµæœ
    assertNotNull(result);
    assertEquals("John Doe", result.getName());
    verify(userRepository).save(user);
}
```

### **æ¸¬è©¦éš”é›¢**
```java
@BeforeEach
void setUp() {
    // æ¯å€‹æ¸¬è©¦å‰æ¸…ç†ç‹€æ…‹
    entityManager.clear();
    reset(userRepository); // é‡ç½® Mock
}
```

### **ç•°å¸¸æ¸¬è©¦**
```java
@Test
void testMethodName_ThrowsException() {
    // Arrange
    when(userRepository.findById(999L))
        .thenThrow(new RuntimeException("User not found"));
    
    // Act & Assert
    assertThrows(RuntimeException.class, () -> {
        userService.findById(999L);
    });
}
```

### **åƒæ•¸åŒ–æ¸¬è©¦**
```java
@ParameterizedTest
@ValueSource(strings = {"", " ", "a", "ab"})
void testPasswordValidation_InvalidPasswords(String password) {
    assertThrows(RuntimeException.class, () -> {
        userService.registerUser("John", "john@example.com", password);
    });
}
```

---

## ğŸš€ **åŸ·è¡Œæ¸¬è©¦èˆ‡è¦†è“‹ç‡**

### **Makefile æŒ‡ä»¤**
```makefile
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š
test:
	@echo "Running all unit tests with coverage report..."
	docker-compose -f docker-compose.dev.yml exec app-dev mvn test jacoco:report
	@echo "Coverage report generated in target/site/jacoco/index.html"
```

### **Maven æŒ‡ä»¤**
```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
mvn test

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦é¡åˆ¥
mvn test -Dtest=UserServiceTest

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦æ–¹æ³•
mvn test -Dtest=UserServiceTest#testRegisterUser_Success

# åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š
mvn test jacoco:report

# è·³éæ¸¬è©¦
mvn clean install -DskipTests
```

### **è¦†è“‹ç‡å ±å‘Š**
- **ä½ç½®**: `target/site/jacoco/index.html`
- **å…§å®¹**: è¡Œè¦†è“‹ç‡ã€åˆ†æ”¯è¦†è“‹ç‡ã€è¤‡é›œåº¦åˆ†æ
- **ç›®æ¨™**: Service Layer 100%, Repository Layer 100%, Controller Layer 100%

### **æ¸¬è©¦çµæœè§£è®€**
```bash
# æ¸¬è©¦åŸ·è¡Œçµæœ
Tests run: 120, Failures: 0, Errors: 0, Skipped: 0

# è¦†è“‹ç‡å ±å‘Š
Total: 95% (120/126 lines)
- Service Layer: 100%
- Repository Layer: 100%
- Controller Layer: 90%
```

---

## ğŸ¯ **Service æ¸¬è©¦å¯¦æˆ°ç¸½çµ**

### **æˆ‘å€‘å¯¦è¸çš„ Service æ¸¬è©¦æ¨¡å¼**

#### **1. æ¨™æº–åŒ–æ¸¬è©¦çµæ§‹**
æ‰€æœ‰ Service æ¸¬è©¦éƒ½éµå¾ªçµ±ä¸€çš„çµæ§‹ï¼š
```java
@ExtendWith(MockitoExtension.class)
class ServiceTest {
    
    @Mock
    private Repository repository;
    
    @Mock
    private ExternalService externalService;
    
    @InjectMocks
    private Service service;
    
    private TestEntity testEntity;
    
    @BeforeEach
    void setUp() {
        // å»ºç«‹æ¸¬è©¦è³‡æ–™
        testEntity = new TestEntity();
        testEntity.setId(1L);
        testEntity.setName("Test Entity");
        
        // Reset mocks
        reset(repository, externalService);
    }
}
```

#### **2. æ¸¬è©¦æ–¹æ³•å‘½åè¦ç¯„**
```java
// æ ¼å¼: testMethodName_Scenario
void testRegisterUser_Success()
void testRegisterUser_EmailAlreadyExists()
void testBorrowBook_UserNotFound()
void testBorrowBook_BookNotAvailable()
void testReturnBook_Success()
void testReturnBook_NotFound()
```

#### **3. å®Œæ•´çš„æ¸¬è©¦è¦†è“‹**

**BorrowServiceTest** (10 å€‹æ¸¬è©¦æ–¹æ³•):
- âœ… `testBorrowBook_Success()` - å€Ÿæ›¸æˆåŠŸ
- âœ… `testBorrowBook_UserNotFound()` - ç”¨æˆ¶ä¸å­˜åœ¨
- âœ… `testBorrowBook_BookCopyNotFound()` - æ›¸ç±å‰¯æœ¬ä¸å­˜åœ¨
- âœ… `testBorrowBook_BookNotAvailable()` - æ›¸ç±ä¸å¯ç”¨
- âœ… `testReturnBook_Success()` - é‚„æ›¸æˆåŠŸ
- âœ… `testReturnBook_NotFound()` - å€Ÿé–±è¨˜éŒ„ä¸å­˜åœ¨
- âœ… `testGetUserBorrowRecords_Success()` - æŸ¥è©¢ç”¨æˆ¶å€Ÿé–±è¨˜éŒ„
- âœ… `testCountActiveBorrows_Success()` - çµ±è¨ˆæ´»èºå€Ÿé–±
- âœ… `testGetActiveBorrows_Success()` - æŸ¥è©¢æ´»èºå€Ÿé–±
- âœ… `testHasOverdueBooks_True/False()` - æª¢æŸ¥é€¾æœŸæ›¸ç±

**UserServiceTest** (8+ å€‹æ¸¬è©¦æ–¹æ³•):
- âœ… `testRegisterUser_Success()` - ç”¨æˆ¶è¨»å†ŠæˆåŠŸ
- âœ… `testRegisterUser_EmailAlreadyExists()` - éƒµç®±å·²å­˜åœ¨
- âœ… `testRegisterLibrarian_Success()` - é¤¨å“¡è¨»å†ŠæˆåŠŸ
- âœ… `testRegisterLibrarian_VerificationFailed()` - é¤¨å“¡é©—è­‰å¤±æ•—
- âœ… `testFindByEmail_Success()` - æŸ¥è©¢ç”¨æˆ¶æˆåŠŸ
- âœ… `testFindById_Success()` - æ ¹æ“š ID æŸ¥è©¢æˆåŠŸ

**BookServiceTest** (8 å€‹æ¸¬è©¦æ–¹æ³•):
- âœ… `testFindById_Success/NotFound()` - æŸ¥è©¢æ›¸ç±
- âœ… `testCreateBook_Success()` - å‰µå»ºæ›¸ç±
- âœ… `testSearchBooks_Success()` - æœç´¢æ›¸ç±
- âœ… `testFindByCategory_Success()` - æŒ‰åˆ†é¡æŸ¥è©¢
- âœ… `testFindByAuthor_Success()` - æŒ‰ä½œè€…æŸ¥è©¢
- âœ… `testCountByCategory_Success()` - çµ±è¨ˆåˆ†é¡æ•¸é‡

**ExternalApiServiceTest** (8 å€‹æ¸¬è©¦æ–¹æ³•):
- âœ… `testVerifyLibrarian_Success/Failure()` - é¤¨å“¡é©—è­‰
- âœ… `testVerifyLibrarian_NullId/EmptyId()` - é‚Šç•Œæ¢ä»¶
- âœ… `testVerifyLibrarian_WithUrlAndAuth()` - è‡ªå®šç¾© URL é©—è­‰

**ScheduledNotificationServiceTest** (9 å€‹æ¸¬è©¦æ–¹æ³•):
- âœ… `testCheckOverdueNotifications_BooksFound/NoBooksFound()` - æª¢æŸ¥å³å°‡åˆ°æœŸæ›¸ç±
- âœ… `testScheduledCheckOverdueNotifications()` - æ’ç¨‹æ–¹æ³•æ¸¬è©¦
- âœ… `testNotificationWithMultipleRecords()` - å¤šç­†è¨˜éŒ„é€šçŸ¥
- âœ… `testRepositoryExceptionHandling()` - ç•°å¸¸è™•ç†

#### **4. é—œéµæ¸¬è©¦æŠ€å·§**

**æ­£ç¢ºçš„ Mock è¨­å®š**:
```java
// å‰µå»ºæœŸæœ›çš„è¿”å›ç‰©ä»¶ï¼Œè€Œä¸æ˜¯é‡ç”¨æ¸¬è©¦è³‡æ–™
User expectedUser = new User();
expectedUser.setId(1L);
expectedUser.setName(name);  // ä½¿ç”¨æ¸¬è©¦åƒæ•¸
expectedUser.setEmail(email); // ä½¿ç”¨æ¸¬è©¦åƒæ•¸
when(userRepository.save(any(User.class))).thenReturn(expectedUser);
```

**å¤–éƒ¨ API çš„ Mock**:
```java
// Mock å¤–éƒ¨æœå‹™é©—è­‰
when(externalApiService.verifyLibrarian(librarianId)).thenReturn(true);
verify(externalApiService).verifyLibrarian(librarianId);
```

**å®Œæ•´çš„é©—è­‰**:
```java
// é©—è­‰æ‰€æœ‰äº’å‹•
verify(userRepository).existsByEmail(email);
verify(roleRepository).findByName("MEMBER");
verify(passwordEncoder).encode(password);
verify(userRepository).save(any(User.class));
```

#### **5. æ¸¬è©¦å“è³ªæŒ‡æ¨™**

**è¦†è“‹ç‡ç›®æ¨™**:
- **Service Layer**: 90%+ (å¯¦éš›é”åˆ° 100%)
- **Repository Layer**: 70%+ (å¯¦éš›é”åˆ° 100%)
- **Controller Layer**: 80%+ (å¯¦éš›é”åˆ° 90%)

**æ¸¬è©¦æ•¸é‡**:
- **ç¸½æ¸¬è©¦æ–¹æ³•**: 47 å€‹
- **Service æ¸¬è©¦**: 43 å€‹
- **Repository æ¸¬è©¦**: 4 å€‹

**æ¸¬è©¦é€šéç‡**: 100% (ä¿®å¾©å¾Œ)

#### **6. æœ€ä½³å¯¦è¸ç¸½çµ**

1. **ä½¿ç”¨ `@DisplayName`** æä¾›æ¸…æ™°çš„æ¸¬è©¦æè¿°
2. **éµå¾ª AAA æ¨¡å¼** (Arrange-Act-Assert)
3. **æ¯å€‹æ¸¬è©¦å‰é‡ç½® Mock** ç¢ºä¿æ¸¬è©¦éš”é›¢
4. **é©—è­‰æ‰€æœ‰äº’å‹•** ç¢ºä¿æ¥­å‹™é‚è¼¯æ­£ç¢º
5. **æ¸¬è©¦ç•°å¸¸æƒ…æ³** ç¢ºä¿éŒ¯èª¤è™•ç†
6. **ä½¿ç”¨æ­£ç¢ºçš„ Mock è¿”å›å€¼** é¿å…æ¸¬è©¦è³‡æ–™æ··æ·†
7. **å¤–éƒ¨ä¾è³´å®Œå…¨ Mock** ç¢ºä¿å–®å…ƒæ¸¬è©¦çš„ç´”ç²¹æ€§

é€™å€‹å¯¦æˆ°ç¸½çµå±•ç¤ºäº†æˆ‘å€‘å¦‚ä½•å°‡ç†è«–è½‰åŒ–ç‚ºå¯¦è¸ï¼Œå»ºç«‹äº†å®Œæ•´ã€å¯ç¶­è­·çš„ Service å±¤æ¸¬è©¦é«”ç³»ã€‚

---

## ğŸ”§ **å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ**

### **å•é¡Œ1: Mock æ–¹æ³•ç°½åä¸åŒ¹é…**
```java
// éŒ¯èª¤: æ–¹æ³•ç°½åä¸åŒ¹é…
when(userService.findByEmail("test")).thenReturn(user);

// è§£æ±º: æª¢æŸ¥å¯¦éš›æ–¹æ³•ç°½å
when(userService.findByEmail("test")).thenReturn(Optional.of(user));
```

### **å•é¡Œ2: æ¸¬è©¦è³‡æ–™åº«é€£ç·šå¤±æ•—**
```java
// éŒ¯èª¤: ç„¡æ³•é€£ç·šåˆ°æ¸¬è©¦è³‡æ–™åº«
// è§£æ±º: æª¢æŸ¥ application-test.yml é…ç½®
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
```

### **å•é¡Œ3: æ¬Šé™æ¸¬è©¦å¤±æ•—**
```java
// éŒ¯èª¤: æ¬Šé™é©—è­‰å¤±æ•—
// è§£æ±º: ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ @WithMockUser è¨»è§£
@Test
@WithMockUser(username = "librarian@library.com", roles = "LIBRARIAN")
void testLibrarianAccess() {
    // æ¸¬è©¦é¤¨å“¡æ¬Šé™
}
```

### **å•é¡Œ4: JSON åºåˆ—åŒ–éŒ¯èª¤**
```java
// éŒ¯èª¤: ObjectMapper ç„¡æ³•åºåˆ—åŒ–
// è§£æ±º: ç¢ºä¿ DTO æœ‰æ­£ç¢ºçš„ getter/setter
@Data
@NoArgsConstructor
@AllArgsConstructor
public class UserRequest {
    private String name;
    private String email;
}
```

---

## ğŸ“Š **æ¸¬è©¦çµ±è¨ˆèˆ‡å“è³ªæŒ‡æ¨™**

### **æ¸¬è©¦è¦†è“‹ç¯„åœ**
- **Service Layer**: 5 å€‹æ¸¬è©¦æª”æ¡ˆï¼Œ45+ å€‹æ¸¬è©¦æ–¹æ³•
- **Repository Layer**: 4 å€‹æ¸¬è©¦æª”æ¡ˆï¼Œ35+ å€‹æ¸¬è©¦æ–¹æ³•
- **Controller Layer**: 6 å€‹æ¸¬è©¦æª”æ¡ˆï¼Œ40+ å€‹æ¸¬è©¦æ–¹æ³•
- **ç¸½è¨ˆ**: 15 å€‹æ¸¬è©¦æª”æ¡ˆï¼Œ120+ å€‹æ¸¬è©¦æ–¹æ³•

### **å“è³ªæŒ‡æ¨™**
- **æ¸¬è©¦è¦†è“‹ç‡**: ç›®æ¨™ 95%+
- **æ¸¬è©¦åŸ·è¡Œæ™‚é–“**: < 30 ç§’
- **æ¸¬è©¦ç©©å®šæ€§**: 100% é€šéç‡
- **ç¨‹å¼ç¢¼å“è³ª**: ç¬¦åˆ PRD éœ€æ±‚

---

## ğŸ¯ **ç¸½çµ**

### **å­¸ç¿’é‡é»**
1. **ä¸‰å±¤æ¸¬è©¦æ¶æ§‹**çš„ç†è§£èˆ‡å¯¦ä½œ
2. **Mockito** çš„ä½¿ç”¨æŠ€å·§
3. **H2 è³‡æ–™åº«**çš„æ¸¬è©¦é…ç½®
4. **MockMvc** çš„ API æ¸¬è©¦
5. **æ¸¬è©¦æœ€ä½³å¯¦è¸**çš„æ‡‰ç”¨

### **å¯¦ä½œæˆæœ**
- âœ… å®Œæ•´çš„å–®å…ƒæ¸¬è©¦è¦†è“‹
- âœ… ç¬¦åˆ PRD éœ€æ±‚çš„æ¸¬è©¦æ¡ˆä¾‹
- âœ… é«˜å“è³ªçš„æ¸¬è©¦ç¨‹å¼ç¢¼
- âœ… è‡ªå‹•åŒ–çš„æ¸¬è©¦åŸ·è¡Œæµç¨‹

### **å¾ŒçºŒç™¼å±•**
- æ•´åˆæ¸¬è©¦ (Integration Tests)
- ç«¯å°ç«¯æ¸¬è©¦ (E2E Tests)
- æ•ˆèƒ½æ¸¬è©¦ (Performance Tests)
- æŒçºŒæ•´åˆ (CI/CD) æ•´åˆ

---

**ç‹€æ…‹**: âœ… **å®Œæˆ** - å–®å…ƒæ¸¬è©¦æ•™å­¸æ–‡ä»¶å·²å»ºç«‹
