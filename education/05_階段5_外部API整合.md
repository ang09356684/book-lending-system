# 階段6: 外部API整合

## 📋 **學習目標**

本文件將詳細說明如何整合外部API來驗證館員身份，實現與其他系統的整合。

### **學習重點**
- 了解外部API整合的目的和重要性
- 學習如何使用RestTemplate進行HTTP請求
- 掌握外部API的錯誤處理機制
- 理解配置管理的最佳實踐

---

## 🎯 **外部API整合概述**

### **為什麼需要外部API整合？**

在實際的圖書館系統中，館員身份驗證通常需要與現有的人事系統或館員管理系統進行整合，確保：

- ✅ **身份驗證的權威性** - 只有真正的館員才能註冊館員帳號
- ✅ **資料一致性** - 避免重複建立館員資料
- ✅ **權限控制** - 館員有特殊權限，需要嚴格驗證
- ✅ **系統整合** - 與現有的管理系統保持同步

### **整合需求**

根據PRD文件，館員註冊時需要：

```http
Method: GET
URL: https://todo.com.tw
Headers: { "Authorization": "todo" }
```

---

## 🔧 **實作步驟**

### **步驟1: 建立ExternalApiService**

```java
@Service
public class ExternalApiService {
    
    private final RestTemplate restTemplate;
    
    @Value("${external.librarian.verification-url:https://todo.com.tw}")
    private String verificationUrl;
    
    @Value("${external.librarian.authorization-header:todo}")
    private String authorizationHeader;
    
    public ExternalApiService() {
        this.restTemplate = new RestTemplate();
    }
    
    public boolean verifyLibrarian(String librarianId) {
        // 實作外部API呼叫邏輯
    }
}
```

### **步驟2: 配置管理**

在 `application.yml` 中配置外部API參數：

```yaml
# External API configuration
external:
  librarian:
    verification-url: https://todo.com.tw
    authorization-header: todo
```

### **步驟3: 整合到UserService**

```java
@Service
public class UserService {
    
    private final ExternalApiService externalApiService;
    
    public User registerLibrarian(String username, String email, String password, String fullName, String librarianId) {
        // 驗證輸入參數
        
        // 呼叫外部API驗證館員身份
        boolean isVerified = externalApiService.verifyLibrarian(librarianId);
        if (!isVerified) {
            throw new RuntimeException("Librarian verification failed");
        }
        
        // 建立館員帳號
        // ...
    }
}
```

---

## 📚 **核心概念**

### **1. RestTemplate**

RestTemplate是Spring提供的HTTP客戶端工具，用於呼叫外部API：

```java
// 建立RestTemplate
RestTemplate restTemplate = new RestTemplate();

// 設定請求標頭
HttpHeaders headers = new HttpHeaders();
headers.set("Authorization", "todo");

// 建立HTTP實體
HttpEntity<String> entity = new HttpEntity<>(headers);

// 發送GET請求
ResponseEntity<String> response = restTemplate.exchange(
    "https://todo.com.tw",
    HttpMethod.GET,
    entity,
    String.class
);
```

### **2. 配置注入**

使用 `@Value` 註解從配置檔案注入參數：

```java
@Value("${external.librarian.verification-url}")
private String verificationUrl;

@Value("${external.librarian.authorization-header}")
private String authorizationHeader;
```

### **3. 錯誤處理**

外部API呼叫可能失敗，需要適當的錯誤處理：

```java
try {
    // 呼叫外部API
    ResponseEntity<String> response = restTemplate.exchange(...);
    return response.getStatusCode().is2xxSuccessful();
} catch (RestClientException e) {
    // 記錄錯誤並返回false
    System.err.println("External API verification failed: " + e.getMessage());
    return false;
}
```

---

## ⚠️ **注意事項**

### **1. 網路延遲**

外部API呼叫會增加響應時間：

```java
// 建議設定超時時間
@Bean
public RestTemplate restTemplate() {
    SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory();
    factory.setConnectTimeout(5000);  // 5秒連接超時
    factory.setReadTimeout(10000);    // 10秒讀取超時
    return new RestTemplate(factory);
}
```

### **2. 錯誤處理**

外部API可能不可用，需要優雅的錯誤處理：

```java
public boolean verifyLibrarian(String librarianId) {
    try {
        // 呼叫外部API
        return callExternalApi(librarianId);
    } catch (Exception e) {
        // 記錄錯誤
        log.error("External API verification failed for librarian: " + librarianId, e);
        
        // 根據業務需求決定是否允許註冊
        // 選項1: 拒絕註冊
        return false;
        
        // 選項2: 允許註冊（需要管理員審核）
        // return true;
    }
}
```

### **3. 安全性**

外部API呼叫涉及敏感資訊，需要注意安全：

```java
// 不要在日誌中記錄敏感資訊
log.info("Verifying librarian with external system");  // ✅ 正確
log.info("Verifying librarian ID: " + librarianId);    // ❌ 避免記錄敏感資訊
```

### **4. 測試**

外部API整合需要特別的測試策略：

```java
@Test
void testLibrarianVerification() {
    // 使用Mockito模擬外部API
    when(externalApiService.verifyLibrarian("valid-id")).thenReturn(true);
    when(externalApiService.verifyLibrarian("invalid-id")).thenReturn(false);
    
    // 測試成功案例
    User librarian = userService.registerLibrarian("librarian", "test@example.com", "password", "Test Librarian", "valid-id");
    assertNotNull(librarian);
    
    // 測試失敗案例
    assertThrows(RuntimeException.class, () -> {
        userService.registerLibrarian("librarian2", "test2@example.com", "password", "Test Librarian 2", "invalid-id");
    });
}
```

---

## 🎯 **最佳實踐**

### **1. 配置管理**

- ✅ 使用配置檔案管理外部API參數
- ✅ 提供預設值避免配置缺失
- ✅ 使用環境變數管理敏感資訊

### **2. 錯誤處理**

- ✅ 捕獲所有可能的異常
- ✅ 提供有意義的錯誤訊息
- ✅ 記錄詳細的錯誤日誌

### **3. 效能優化**

- ✅ 設定適當的超時時間
- ✅ 考慮使用快取機制
- ✅ 監控外部API的響應時間

### **4. 安全性**

- ✅ 不要在日誌中記錄敏感資訊
- ✅ 使用HTTPS進行安全通訊
- ✅ 驗證外部API的回應

---

## 📊 **總結**

### **外部API整合的核心要素**

1. **RestTemplate** - HTTP客戶端工具
2. **配置管理** - 外部參數的集中管理
3. **錯誤處理** - 優雅的異常處理
4. **安全性** - 保護敏感資訊
5. **測試** - 完整的測試覆蓋

### **學習檢查清單**

- [ ] 了解外部API整合的目的
- [ ] 掌握RestTemplate的使用方法
- [ ] 學會配置管理的最佳實踐
- [ ] 理解錯誤處理的重要性
- [ ] 能夠編寫外部API整合的測試

---

**現在您已經了解了外部API整合的核心概念和實作方法！**
