# 單元測試套件說明
## Unit Testing Packages Documentation

---

### 📋 **目錄**
1. [JUnit 5 套件](#junit-5-套件)
2. [Mockito 套件](#mockito-套件)
3. [Spring Boot Test 套件](#spring-boot-test-套件)
4. [H2 Database 套件](#h2-database-套件)
5. [JaCoCo 套件](#jacoco-套件)
6. [測試註解說明](#測試註解說明)
7. [常用斷言方法](#常用斷言方法)

---

## 🧪 **JUnit 5 套件**

### **核心功能**
JUnit 5 是 Java 的標準測試框架，提供測試執行、斷言和測試生命週期管理。

### **主要套件**
```java
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.RepeatedTest;
import org.junit.jupiter.api.ParameterizedTest;
import org.junit.jupiter.api.ValueSource;
import org.junit.jupiter.api.extension.ExtendWith;
```

### **生命週期註解**
```java
@BeforeAll
static void setUpAll() {
    // 在所有測試前執行一次
}

@BeforeEach
void setUp() {
    // 在每個測試前執行
}

@AfterEach
void tearDown() {
    // 在每個測試後執行
}

@AfterAll
static void tearDownAll() {
    // 在所有測試後執行一次
}
```

### **測試註解**
```java
@Test
@DisplayName("測試使用者註冊成功")
void testRegisterUser_Success() {
    // 測試邏輯
}

@RepeatedTest(3)
void testRepeatedTest() {
    // 重複執行 3 次
}

@ParameterizedTest
@ValueSource(strings = {"test1", "test2", "test3"})
void testParameterized(String input) {
    // 參數化測試
}
```

---

## 🎭 **Mockito 套件**

### **核心功能**
Mockito 是用於建立 Mock 物件的框架，用於模擬依賴和驗證互動。

### **主要套件**
```java
import org.mockito.Mock;
import org.mockito.InjectMocks;
import org.mockito.MockitoAnnotations;
import org.mockito.junit.jupiter.MockitoExtension;
import static org.mockito.Mockito.*;
import static org.mockito.ArgumentMatchers.*;
```

### **Mock 建立**
```java
// 方法 1: 使用 @Mock 註解
@Mock
private UserRepository userRepository;

// 方法 2: 使用 Mockito.mock()
UserRepository userRepository = Mockito.mock(UserRepository.class);

// 方法 3: 使用 MockitoAnnotations
@BeforeEach
void setUp() {
    MockitoAnnotations.openMocks(this);
}
```

### **Mock 行為設定**
```java
// 基本回傳值
when(userRepository.findById(1L)).thenReturn(Optional.of(user));

// 參數匹配器
when(userRepository.findByEmail(anyString())).thenReturn(Optional.of(user));
when(userRepository.save(any(User.class))).thenReturn(user);

// 拋出例外
when(userRepository.findById(999L))
    .thenThrow(new RuntimeException("User not found"));

// Void 方法
doNothing().when(userRepository).delete(user);

// 連續呼叫不同回傳值
when(userRepository.findById(1L))
    .thenReturn(Optional.of(user1))
    .thenReturn(Optional.of(user2));
```

### **參數匹配器**
```java
// 基本匹配器
any()           // 任何物件
anyString()     // 任何字串
anyInt()        // 任何整數
anyLong()       // 任何長整數
anyBoolean()    // 任何布林值
anyList()       // 任何列表
anyMap()        // 任何映射

// 特定匹配器
eq("value")     // 等於特定值
argThat()       // 自定義匹配器
isNull()        // 空值
isNotNull()     // 非空值
contains("text") // 包含文字
```

### **驗證方法**
```java
// 基本驗證
verify(userRepository).findById(1L);

// 驗證呼叫次數
verify(userRepository, times(1)).findById(1L);
verify(userRepository, never()).delete(any());
verify(userRepository, atLeastOnce()).save(any());
verify(userRepository, atMost(3)).findAll();

// 驗證參數
verify(userRepository).save(argThat(user -> 
    user.getName().equals("John Doe")
));

// 驗證互動順序
InOrder inOrder = inOrder(userRepository);
inOrder.verify(userRepository).findById(1L);
inOrder.verify(userRepository).save(any());
```

---

## 🌱 **Spring Boot Test 套件**

### **核心功能**
Spring Boot Test 提供 Spring 應用程式的測試支援，包括整合測試和單元測試。

### **主要套件**
```java
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockHttpServletRequestBuilder;
import org.springframework.test.web.servlet.result.MockMvcResultMatchers;
```

### **測試註解**
```java
// 完整 Spring 應用程式測試
@SpringBootTest
class FullApplicationTest {
    // 載入完整的 Spring 應用程式
}

// Web 層測試
@WebMvcTest(UserController.class)
class UserControllerTest {
    // 只載入 Web 層相關的 Bean
}

// 資料庫層測試
@DataJpaTest
class UserRepositoryTest {
    // 只載入 JPA 相關的 Bean
}

// 使用特定 Profile
@ActiveProfiles("test")
class ProfileTest {
    // 使用 test profile 的配置
}
```

### **MockMvc 使用**
```java
@Autowired
private MockMvc mockMvc;

// GET 請求
mockMvc.perform(get("/users/1"))
    .andExpect(status().isOk())
    .andExpect(jsonPath("$.success").value(true));

// POST 請求
mockMvc.perform(post("/users")
    .contentType(MediaType.APPLICATION_JSON)
    .content("{\"name\":\"John\",\"email\":\"john@example.com\"}"))
    .andExpect(status().isCreated());

// 帶參數的請求
mockMvc.perform(get("/users")
    .param("page", "0")
    .param("size", "10"))
    .andExpect(status().isOk());
```

### **JSON 路徑驗證**
```java
// 基本路徑驗證
.andExpect(jsonPath("$.success").value(true))
.andExpect(jsonPath("$.data.id").value(1))
.andExpect(jsonPath("$.data.name").value("John Doe"))

// 陣列驗證
.andExpect(jsonPath("$.data").isArray())
.andExpect(jsonPath("$.data[0].id").value(1))
.andExpect(jsonPath("$.data").hasSize(3))

// 存在性驗證
.andExpect(jsonPath("$.data").exists())
.andExpect(jsonPath("$.error").doesNotExist())

// 類型驗證
.andExpect(jsonPath("$.data.id").isNumber())
.andExpect(jsonPath("$.data.name").isString())
```

---

## 🗄️ **H2 Database 套件**

### **核心功能**
H2 是輕量級的記憶體資料庫，常用於單元測試和整合測試。

### **主要套件**
```java
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager;
import org.springframework.boot.test.autoconfigure.orm.jpa.AutoConfigureTestDatabase;
import com.h2database.h2.H2Database;
```

### **配置設定**
```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.H2Dialect
  
  h2:
    console:
      enabled: true
      path: /h2-console
```

### **TestEntityManager 使用**
```java
@Autowired
private TestEntityManager entityManager;

// 建立並儲存實體
User user = new User("John Doe", "john@example.com");
User savedUser = entityManager.persistAndFlush(user);

// 查詢實體
User foundUser = entityManager.find(User.class, savedUser.getId());

// 清理資料
entityManager.clear();
entityManager.flush();

// 移除實體
entityManager.remove(user);
```

### **資料庫測試範例**
```java
@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @BeforeEach
    void setUp() {
        entityManager.clear();
    }
    
    @Test
    void testFindByEmail_Success() {
        // Arrange
        User user = new User("John Doe", "john@example.com");
        entityManager.persistAndFlush(user);
        
        // Act
        Optional<User> result = userRepository.findByEmail("john@example.com");
        
        // Assert
        assertTrue(result.isPresent());
        assertEquals("John Doe", result.get().getName());
    }
}
```

---

## 📊 **JaCoCo 套件**

### **核心功能**
JaCoCo 是 Java 程式碼覆蓋率分析工具，提供詳細的覆蓋率報告。

### **Maven 配置**
```xml
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.11</version>
    <executions>
        <execution>
            <goals>
                <goal>prepare-agent</goal>
            </goals>
        </execution>
        <execution>
            <id>report</id>
            <phase>test</phase>
            <goals>
                <goal>report</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

### **執行指令**
```bash
# 執行測試並產生覆蓋率報告
mvn test jacoco:report

# 只產生覆蓋率報告
mvn jacoco:report

# 檢查覆蓋率閾值
mvn jacoco:check
```

### **覆蓋率報告**
- **位置**: `target/site/jacoco/index.html`
- **內容**:
  - 行覆蓋率 (Line Coverage)
  - 分支覆蓋率 (Branch Coverage)
  - 複雜度分析 (Complexity)
  - 方法覆蓋率 (Method Coverage)
  - 類別覆蓋率 (Class Coverage)

---

## 🏷️ **測試註解說明**

### **JUnit 5 註解**
```java
@Test                    // 標記測試方法
@DisplayName("描述")      // 提供測試描述
@Disabled("原因")         // 停用測試
@Tag("標籤")             // 標記測試分類
@RepeatedTest(3)         // 重複執行測試
@ParameterizedTest       // 參數化測試
@Nested                  // 巢狀測試類別
```

### **Spring Boot 註解**
```java
@SpringBootTest          // 完整應用程式測試
@WebMvcTest              // Web 層測試
@DataJpaTest             // 資料庫層測試
@AutoConfigureTestDatabase // 自動配置測試資料庫
@ActiveProfiles("test")  // 使用特定 Profile
@DirtiesContext          // 標記會修改 Spring 上下文
```

### **Mockito 註解**
```java
@Mock                    // 建立 Mock 物件
@InjectMocks             // 注入 Mock 到被測試物件
@Spy                     // 建立 Spy 物件 (部分 Mock)
@Captor                  // 捕獲方法參數
```

### **Spring Security 註解**
```java
@WithMockUser            // 模擬使用者
@WithUserDetails         // 模擬使用者詳細資訊
@WithAnonymousUser       // 模擬匿名使用者
@WithMockUser(roles = "ADMIN") // 指定角色
```

---

## ✅ **常用斷言方法**

### **JUnit 5 斷言**
```java
// 基本斷言
assertEquals(expected, actual);
assertNotEquals(expected, actual);
assertTrue(condition);
assertFalse(condition);
assertNull(object);
assertNotNull(object);

// 陣列斷言
assertArrayEquals(expected, actual);
assertArrayEquals(expected, actual, "message");

// 集合斷言
assertIterableEquals(expected, actual);
assertLinesMatch(expected, actual);

// 例外斷言
assertThrows(ExceptionClass.class, () -> {
    // 會拋出例外的程式碼
});

assertDoesNotThrow(() -> {
    // 不會拋出例外的程式碼
});

// 超時斷言
assertTimeout(Duration.ofSeconds(5), () -> {
    // 在 5 秒內完成的程式碼
});
```

### **Hamcrest 斷言**
```java
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.*;

// 基本匹配器
assertThat(actual, is(expected));
assertThat(actual, equalTo(expected));
assertThat(actual, not(equalTo(expected)));

// 字串匹配器
assertThat(actual, containsString("text"));
assertThat(actual, startsWith("prefix"));
assertThat(actual, endsWith("suffix"));
assertThat(actual, matchesPattern("regex"));

// 數值匹配器
assertThat(actual, greaterThan(10));
assertThat(actual, lessThan(100));
assertThat(actual, between(1, 10));

// 集合匹配器
assertThat(actual, hasSize(3));
assertThat(actual, contains("item1", "item2"));
assertThat(actual, hasItem("item"));
assertThat(actual, empty());
```

### **Mockito 斷言**
```java
// 驗證方法呼叫
verify(mock).method();
verify(mock, times(1)).method();
verify(mock, never()).method();
verify(mock, atLeastOnce()).method();
verify(mock, atMost(3)).method();

// 驗證參數
verify(mock).method(eq("expected"));
verify(mock).method(anyString());
verify(mock).method(argThat(arg -> arg.equals("expected")));

// 驗證互動順序
InOrder inOrder = inOrder(mock);
inOrder.verify(mock).method1();
inOrder.verify(mock).method2();
```

---

## 🔧 **最佳實踐**

### **測試命名**
```java
// 格式: testMethodName_Scenario
void testRegisterUser_Success()
void testRegisterUser_EmailAlreadyExists()
void testRegisterUser_InvalidPassword()
void testGetUserById_NotFound()
void testUpdateUser_AccessDenied()
```

### **測試結構**
```java
@Test
void testMethodName_Scenario() {
    // Arrange - 準備測試資料
    User user = new User("John Doe", "john@example.com");
    when(userRepository.save(any())).thenReturn(user);
    
    // Act - 執行被測試方法
    User result = userService.createUser(user);
    
    // Assert - 驗證結果
    assertNotNull(result);
    assertEquals("John Doe", result.getName());
    verify(userRepository).save(user);
}
```

### **測試隔離**
```java
@BeforeEach
void setUp() {
    // 清理狀態
    entityManager.clear();
    reset(userRepository);
}
```

### **測試資料管理**
```java
// 使用 @BeforeEach 建立測試資料
@BeforeEach
void setUp() {
    testUser = new User("John Doe", "john@example.com");
    testRole = new Role("MEMBER");
}

// 使用測試工廠方法
private User createTestUser(String name, String email) {
    return new User(name, email);
}
```

---

**狀態**: ✅ **完成** - 單元測試套件說明文件已建立
